<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>sapienipc.ipc_system &mdash; sapienipc 0.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=7026087e"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #1565c0" >

          
          
          <a href="../../index.html" class="icon icon-home">
            sapienipc
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/basics/index.html">Basics</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../API/ipc_system_hyperparameters.html">IPCSystem Hyperparameters</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #1565c0" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">sapienipc</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">sapienipc.ipc_system</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for sapienipc.ipc_system</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">References: \n</span>
<span class="sd">- &quot;IPC paper&quot;: Li, Minchen, Zachary Ferguson, Teseo Schneider, Timothy R. Langlois, Denis Zorin, Daniele Panozzo, Chenfanfu Jiang, and Danny M. Kaufman. &quot;Incremental potential contact: intersection-and inversion-free, large-deformation dynamics.&quot; ACM Trans. Graph. 39, no. 4 (2020): 49. \n</span>
<span class="sd">- &quot;C-IPC paper&quot;: Li, Minchen, Danny M. Kaufman, and Chenfanfu Jiang. “Codimensional Incremental Potential Contact.” ACM Transactions on Graphics 40, no. 4 (August 31, 2021): 1–24. https://doi.org/10.1145/3450626.3459767. \n</span>
<span class="sd">- &quot;ABD paper&quot;: Lan, Lei, Danny M. Kaufman, Minchen Li, Chenfanfu Jiang, and Yin Yang. “Affine Body Dynamics: Fast, Stable &amp; Intersection-Free Simulation of Stiff Materials.” arXiv, January 31, 2022. https://doi.org/10.48550/arXiv.2201.10022. \n</span>
<span class="sd">- &quot;CG slides&quot;: Xu, Zhiliang. &quot;ACMS 40212/60212: Advanced Scientific Computing, Lecture 8: Fast Linear Solvers (Part 5).&quot; (https://www3.nd.edu/~zxu2/acms60212-40212/Lec-09-5.pdf) \n</span>
<span class="sd">- &quot;FEM tutorial&quot;: Sifakis, Eftychios. &quot;FEM simulation of 3D deformable solids: a practitioner&#39;s guide to theory, discretization and model reduction. Part One: The classical FEM method and discretization methodology.&quot; In Acm siggraph 2012 courses, pp. 1-50. 2012. \n</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">warp</span> <span class="k">as</span> <span class="nn">wp</span>
<span class="kn">import</span> <span class="nn">sapien</span>

<span class="kn">from</span> <span class="nn">.ipc_kernels.utils_kernels</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.ipc_kernels.abd_utils_kernels</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.ipc_kernels.line_search_kernels</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.ipc_kernels.cg_solver_kernels</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.ipc_energy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.ipc_component</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.ipc_cg_solver</span> <span class="kn">import</span> <span class="n">CGSolver</span>
<span class="kn">from</span> <span class="nn">.ipc_contact_filter</span> <span class="kn">import</span> <span class="n">IPCContactFilter</span>
<span class="kn">from</span> <span class="nn">.ipc_ccd</span> <span class="kn">import</span> <span class="n">IPCCCD</span>
<span class="kn">from</span> <span class="nn">.ipc_utils.warp_types</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.ipc_utils.global_defs</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sapienipc.ipc_utils.logging_utils</span> <span class="kn">import</span> <span class="n">ipc_logger</span>


<div class="viewcode-block" id="IPCSystemConfig">
<a class="viewcode-back" href="../../API/ipc_system_hyperparameters.html#sapienipc.ipc_system.IPCSystemConfig">[docs]</a>
<span class="k">class</span> <span class="nc">IPCSystemConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration class for IPCSystem.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">######## Memory config ########</span>
        <span class="c1">#: Max number of components in the system.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_components</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span>
        <span class="c1">#: Max number of scenes in the system.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_scenes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
        <span class="c1">#: Max number of planes in the system.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_planes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span>
        <span class="c1">#: Max number of planes in each scene handled by the system.</span>
        <span class="c1">#: This is used in the broad phase (filtering contact pairs).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_planes_per_scene</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
        <span class="c1">#: Max number of particles in the system.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_particles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span>
        <span class="c1">#: Max number of particles in each scene handled by the system.</span>
        <span class="c1">#: This is used in the broad phase (filtering contact pairs).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_surface_primitives_per_scene</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span>
        <span class="c1">#: Max number of blocks in each scene.</span>
        <span class="c1">#: Number of blocks = sum(number of FEM tetrahedra) + number of ABD bodies</span>
        <span class="c1">#: + number of contact pairs after the broad phase.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_blocks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span>

        <span class="c1">#: Device of the system, like &quot;cpu&quot;, &quot;cuda:0&quot;, etc.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">get_preferred_device</span><span class="p">()</span>  <span class="c1"># [&quot;cpu&quot;, &quot;cuda:0&quot;, ...]</span>
        <span class="c1">#: :default: False</span>
        <span class="c1">#:</span>
        <span class="c1">#: Set to True to enable the debug mode. In the debug mode, there</span>
        <span class="c1">#: will be more debug outputs and assertions, lowering the efficiency</span>
        <span class="c1">#: of the system.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1">#: :default: True</span>
        <span class="c1">#:</span>
        <span class="c1">#: Set to True to enable CUDA graph for faster line search and CG solver.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_graph</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1">######## Algorithm hyperparameters ########</span>
        <span class="c1">#: :default: 0.025 s</span>
        <span class="c1">#:</span>
        <span class="c1">#: Time step size of the simulation.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">=</span> <span class="mf">0.025</span>
        <span class="c1">#: :default: (0, 0, -9.8) kg m / s^2</span>
        <span class="c1">#:</span>
        <span class="c1">#: Gravity in the simulation.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gravity</span><span class="p">:</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.8</span><span class="p">)</span>
        <span class="c1">#: :default: 1e-2 m</span>
        <span class="c1">#:</span>
        <span class="c1">#: Distance threshold for barrier function (Eq 6, IPC paper).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_hat</span> <span class="o">=</span> <span class="mf">1e-2</span>
        <span class="c1">#: :default: 1e-2 m</span>
        <span class="c1">#:</span>
        <span class="c1">#: Stopping threshold for Newton&#39;s method (Algo 1, IPC paper).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps_d</span> <span class="o">=</span> <span class="mf">1e-2</span>
        <span class="c1">#: :default: 1e-2 m / s</span>
        <span class="c1">#:</span>
        <span class="c1">#: Relative velocity threshold for smoothed friction (Eq 13, IPC paper).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps_v</span> <span class="o">=</span> <span class="mf">1e-2</span>
        <span class="c1">#: :default: 1e9 m / s</span>
        <span class="c1">#:</span>
        <span class="c1">#: Max velocity for broad phase of collision detection. At the beginning</span>
        <span class="c1">#: of each time step, contact pairs that are at least (v_max * time_step + d_hat)</span>
        <span class="c1">#: apart from each other may be ignored.</span>
        <span class="c1">#:</span>
        <span class="c1">#: .. note:: When v_max is too small, model penetration may happen,</span>
        <span class="c1">#:     leading to wrong results.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_max</span> <span class="o">=</span> <span class="mf">1e9</span>
        <span class="c1">#: :default: 1e3</span>
        <span class="c1">#:</span>
        <span class="c1">#: Coefficient for barrier functions (Eq 5, IPC paper).</span>
        <span class="c1">#:</span>
        <span class="c1">#: .. note:: When kappa is too small, the simulator may get stuck when there is contact.</span>
        <span class="c1">#:     When kappa is too large, there will be larger damping, and</span>
        <span class="c1">#:     the simulator may take more substeps (Newton &amp; CG steps) to converge or</span>
        <span class="c1">#:     even never converge and get stuck.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kappa</span> <span class="o">=</span> <span class="mf">1e3</span>
        <span class="c1">#: :default: 1e3</span>
        <span class="c1">#:</span>
        <span class="c1">#: Coefficient for the orthogonality potential for ABD (Eq 6, ABD paper).</span>
        <span class="c1">#:</span>
        <span class="c1">#: .. note:: When it kappa_affine too small, the ABD objects may deform undesirably.</span>
        <span class="c1">#:     When kappa_affine is too large, there will be larger damping, and</span>
        <span class="c1">#:     the simulator may take more substeps (Newton &amp; CG steps) to converge or</span>
        <span class="c1">#:     even never converge and get stuck.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kappa_affine</span> <span class="o">=</span> <span class="mf">1e3</span>
        <span class="c1">#: :default: 1e2</span>
        <span class="c1">#:</span>
        <span class="c1">#: Coefficient for the L2 penalty terms for kinematic targets (kappa_con * ||x_target - x||^2).</span>
        <span class="c1">#:</span>
        <span class="c1">#: .. note:: When kappa_con is too small, the particles may not reach their</span>
        <span class="c1">#:     kinematic targets (if any).</span>
        <span class="c1">#:     When kappa_con is too large, there will be larger damping, and</span>
        <span class="c1">#:     the simulator may take more substeps (Newton &amp; CG steps) to converge or</span>
        <span class="c1">#:     even never converge and get stuck.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kappa_con</span> <span class="o">=</span> <span class="mf">1e2</span>
        <span class="c1">#: :default: 0.7</span>
        <span class="c1">#: :range: (0.0, 1.0)</span>
        <span class="c1">#:</span>
        <span class="c1">#: Slackness parameters in CCD (Continuous Collision Detection) (Alg 1, C-IPC paper).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccd_slackness</span> <span class="o">=</span> <span class="mf">0.7</span>
        <span class="c1">#: :default: 0.0 m</span>
        <span class="c1">#:</span>
        <span class="c1">#: Thickness value. Set to a very small positive number (much smaller than d_hat)</span>
        <span class="c1">#: to avoid model penetration due to numerical error in CCD.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccd_thickness</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1">#: :default: 0.0</span>
        <span class="c1">#:</span>
        <span class="c1">#: Tet inversion threshold. Set to a very small positive number</span>
        <span class="c1">#: to avoid tetrahedron inversion due to numerical error in CCD.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccd_tet_inversion_thres</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1">#: :default: 1e-6</span>
        <span class="c1">#:</span>
        <span class="c1">#: When the angle between two edges is smaller than arcsin(ee_classify_thres),</span>
        <span class="c1">#: the system does not compute the distance between their corresponding lines as their</span>
        <span class="c1">#: edge-edge distance, as this may underestimate their distance due to numerical error.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ee_classify_thres</span> <span class="o">=</span> <span class="mf">1e-6</span>  <span class="c1"># force using point-point distance if sin &lt; thres</span>
        <span class="c1">#: :default: 1e-3</span>
        <span class="c1">#:</span>
        <span class="c1">#: Activate mollifier for edge-edge barrier function when</span>
        <span class="c1">#: (\|cross(e_1, e_2)\|^2 &lt; \|e_1_rest\|^2 * \|e_1_rest\|^2 * thres).</span>
        <span class="c1">#: (Eq 24, IPC paper).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ee_mollifier_thres</span> <span class="o">=</span> <span class="mf">1e-3</span>

        <span class="c1"># Energies enabling and disabling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_kinetic</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_elastic</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_affine</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_collision</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_friction</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_dbc_energy</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1">#: :default: True</span>
        <span class="c1">#:</span>
        <span class="c1">#: Set to False to ignore self collision (collision between parts of</span>
        <span class="c1">#: the same component). If you know there will not be any self collision</span>
        <span class="c1">#: in the environment, you can safely set this to False to save memory</span>
        <span class="c1">#: improve efficiency.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_self_collision</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1">######## Solver config ########</span>
        <span class="c1">#: :default: 10</span>
        <span class="c1">#:</span>
        <span class="c1">#: Max number of iterations in Newton&#39;s method. This can significantly influence</span>
        <span class="c1">#: the quality of simulation results.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newton_max_iters</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="c1">#: :default: 40</span>
        <span class="c1">#:</span>
        <span class="c1">#: Max number of iterations in CG (Conjugate Gradients) in each Newton iteration.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cg_max_iters</span> <span class="o">=</span> <span class="mi">40</span>
        <span class="c1">#: :default: 10</span>
        <span class="c1">#:</span>
        <span class="c1">#: Max number of iterations in line search (Alg 1 Line 11-15, IPC paper).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_search_max_iters</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="c1">#: :default: 100</span>
        <span class="c1">#:</span>
        <span class="c1">#: Max number of iterations in Additive CCD (Alg 1, C-IPC paper).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccd_max_iters</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="c1">#: :default: &quot;jacobi&quot;</span>
        <span class="c1">#: :choices: [&quot;jacobi&quot;, &quot;none&quot;]</span>
        <span class="c1">#:</span>
        <span class="c1">#: Preconditioner in CG solver.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precondition</span> <span class="o">=</span> <span class="s2">&quot;jacobi&quot;</span>
        <span class="c1">#: :default: 1e-3</span>
        <span class="c1">#:</span>
        <span class="c1">#: CG convergence threshold: quit CG if dot(z, r) &lt; cg_error_tolerance ** 2 * dot (z0, r0) (Page 16, CG slides).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cg_error_tolerance</span> <span class="o">=</span> <span class="mf">1e-3</span>
        <span class="c1">#: :default: 10</span>
        <span class="c1">#:</span>
        <span class="c1">#: Check if CG converges every cg_error_frequency steps.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cg_error_frequency</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spd_project_max</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Number of sweeps in Jacobi EVD?</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;IPCSystemConfig(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="si">}</span><span class="s2">)&quot;</span></div>



<span class="k">class</span> <span class="nc">IPCSystem</span><span class="p">(</span><span class="n">sapien</span><span class="o">.</span><span class="n">System</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">IPCSystemConfig</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;ipc&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">debug</span>

        <span class="c1"># sub-systems (handle different parts of the IPC algorithm)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cg_solver</span> <span class="o">=</span> <span class="n">CGSolver</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="n">IPCContactFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccd</span> <span class="o">=</span> <span class="n">IPCCCD</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">energy_calcs</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">EnergyCalculator</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">enable_kinetic</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">energy_calcs</span><span class="p">[</span><span class="s2">&quot;kinetic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">KineticEnergyCalculator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">enable_elastic</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">energy_calcs</span><span class="p">[</span><span class="s2">&quot;elastic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ElasticEnergyCalculator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">enable_affine</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">energy_calcs</span><span class="p">[</span><span class="s2">&quot;affine&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AffineEnergyCalculator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">enable_collision</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">energy_calcs</span><span class="p">[</span><span class="s2">&quot;collision&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CollisionEnergyCalculator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">enable_friction</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">config</span><span class="o">.</span><span class="n">enable_collision</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">energy_calcs</span><span class="p">[</span><span class="s2">&quot;friction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FrictionEnergyCalculator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">enable_dbc_energy</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">energy_calcs</span><span class="p">[</span><span class="s2">&quot;dbc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DBCEnergyCalculator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">max_c</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">max_components</span>
        <span class="n">max_scenes</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">max_scenes</span>
        <span class="n">max_pla</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">max_planes</span>
        <span class="n">max_plane_per_scene</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">max_planes_per_scene</span>
        <span class="n">max_p</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">max_particles</span>
        <span class="n">max_sur</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">max_surface_primitives_per_scene</span>
        <span class="n">max_b</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">max_blocks</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">device</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_components</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_scenes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_planes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># FEM vertices + ABD affine proxies + ABD vertices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_tets</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># FEM tets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_affines</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># ABD affine bodies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_static_blocks</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># FEM tets + ABD affine bodies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_blocks_this_step</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># static blocks + contact blocks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># surface triangles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># surface edges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># surface vertices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_planes_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># surface planes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles_max</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges_max</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles_max</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_planes_max</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">step_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># increment by config.time_step every step</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">line_search_graph</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">components</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scenes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">######## Component Data ########</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">component_friction</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_c</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">component_removed</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_c</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="c1">######## 1-Element Data ########</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">contact_counter</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="c1">######## Per-Scene Data ########</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_scenes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccd_step</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_scenes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_prev</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_scenes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="c1">######## Plane Data ########</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plane_normals</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_pla</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plane_offsets</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_pla</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plane_component</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_pla</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plane_scene</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_pla</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="c1">######## Particle Data ########</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_p</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_qd</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_p</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_q_prev_step</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_p</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_qd_prev_step</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_p</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">particle_q_prev_it</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_p</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># particle_q of the previous Newton iteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_p</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_p</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># update of particle_q in the current Newton iteration</span>
        <span class="c1"># Target position: particle_q_next_it = particle_q_prev_step + particle_p * alpha</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">particle_q_rest</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_p</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_mass</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_p</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_mask</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_p</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># For each particle, 1.0 if free, 0.0 if fixed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_affine</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_p</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># For each particle, the index of the affine body that it corresponds to</span>
        <span class="c1"># -1 if not an affine body, i.e. a FEM vertex</span>
        <span class="c1"># -2 if one of the 4 affine proxies of some affine body</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_component</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_p</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_scene</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_p</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># For each particle, the id of the component that it corresponds to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_grad</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_p</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># Gradient of the IP function</span>

        <span class="c1">######## Particle Data: Contact Forces (for User API) ########</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">particle_collision_force</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_p</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_friction_force</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_p</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="c1">######## Particle Data: Equality Constraints ########</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">particle_dbc_tag</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">max_p</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
        <span class="p">)</span>  <span class="c1"># before _process_dbc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_dbc_mask</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">max_p</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
        <span class="p">)</span>  <span class="c1"># after _process_dbc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_dbc_q</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_p</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_dbc_delta_q</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_p</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="c1">######## Surface Data ########</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">surface_planes</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="n">max_scenes</span><span class="p">,</span> <span class="n">max_plane_per_scene</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surface_particles</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="n">max_scenes</span><span class="p">,</span> <span class="n">max_sur</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surface_edges</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="n">max_scenes</span><span class="p">,</span> <span class="n">max_sur</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surface_triangles</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="n">max_scenes</span><span class="p">,</span> <span class="n">max_sur</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_planes</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_scenes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_scenes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_scenes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_scenes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="c1">######## Block Data ########</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">max_b</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">wp</span><span class="o">.</span><span class="n">mat33</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># Hessian of the IP function, each 12x12 submatrix is stored as a 4x4 array</span>
        <span class="c1"># of 3x3 wp.mat33 matrices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_indices</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">max_b</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># For each block, the indices of &lt;= 4 particles that it corresponds to</span>
        <span class="c1"># -1 if no particle</span>
        <span class="c1"># Possible block types: [FEM tet, ABD affine body, contact pairs]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_status</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_b</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># For each block, 1 if enabled, 0 if disabled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest_volumes</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_b</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="c1">######## Block Data: FEM Tets ########</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tet_block_ids</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_b</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># List of block ids (first dim coordinates in self.blocks) that are FEM tets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tet_inv_Dm</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_b</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">mat33</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># For each FEM tet, the inverse of its &quot;reference shape matrix&quot; Dm (Page 28, FEM tutorial)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tet_materials</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">max_b</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="c1">######## Block Data: ABD Affine Bodies ########</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">affine_block_ids</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_c</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># List of block ids (first dim coordinates in self.blocks) that are affine proxies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">affine_volumes</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_c</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">affine_mass</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">max_c</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">mat33</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="c1">######## Block Data: Contact ########</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">block_type</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">max_b</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># For block types see ipc_utils/global_defs.py</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contact_d</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_b</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contact_dd_dx</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">max_b</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contact_c</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">max_b</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
        <span class="p">)</span>  <span class="c1"># EE mollifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contact_eps_cross</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_b</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contact_dc_dx</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">max_b</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contact_force</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_b</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contact_T</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="n">max_b</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">mat32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
        <span class="p">)</span>  <span class="c1"># sliding basis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contact_friction</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_b</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="c1">######## Debug Utils ########</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">random_states</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_p</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ipc_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">step_count</span><span class="si">}</span><span class="s2">, time = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_qd</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>

        <span class="n">wp</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q_prev_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">)</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_qd_prev_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_qd</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_process_dbc</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_energy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q_prev_step</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">use_graph</span><span class="p">:</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">capture_begin</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_line_search</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line_search_graph</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">capture_end</span><span class="p">()</span>

        <span class="c1"># if self.debug:</span>
        <span class="c1">#     ipc_logger.debug(</span>
        <span class="c1">#         f&quot;self.block_indices:\n&quot;</span>
        <span class="c1">#         + str(self.block_indices.numpy()[: self.n_blocks_this_step])</span>
        <span class="c1">#     )</span>

        <span class="n">newton_iter</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">newton_iter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># if self.debug:</span>
            <span class="c1">#     ipc_logger.debug(</span>
            <span class="c1">#         f&quot;newton_iter = {newton_iter}, self.particle_q:\n&quot;</span>
            <span class="c1">#         + str(self.particle_q.numpy()[: self.n_particles])</span>
            <span class="c1">#     )</span>

            <span class="c1"># if self.config.debug:</span>
            <span class="c1">#     ipc_logger.debug(f&quot;Newton iteration {newton_iter}&quot;)</span>

            <span class="n">wp</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q_prev_it</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">)</span>

            <span class="c1"># self._preprocess_energy(self.particle_q_prev_it)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_energy</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">,</span>
                <span class="n">output_debug_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span>  <span class="c1"># and not self.config.use_graph,</span>
            <span class="p">)</span>
            <span class="c1"># if self.config.debug:</span>
            <span class="c1"># ipc_logger.debug(f&quot;Newton iteration {newton_iter}, initial energy = {self.energy.numpy()[0]}&quot;)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>

            <span class="c1"># if self.debug:</span>
            <span class="c1">#     ipc_logger.debug(</span>
            <span class="c1">#         f&quot;self.contact_d:\n&quot;</span>
            <span class="c1">#         + str(self.contact_d.numpy()[: self.n_blocks_this_step])</span>
            <span class="c1">#     )</span>

            <span class="c1"># ipc_logger.info(f&quot;self.particle_grad = \n{self.particle_grad.numpy()[:self.n_particles]}&quot;)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cg_solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

            <span class="c1"># # DEBUG: solve with np</span>
            <span class="c1"># hess_np = self._get_dense_matrix_brute_force()</span>

            <span class="c1"># # eig, U = np.linalg.eig(hess_np)</span>
            <span class="c1"># # eig, U = eig.real, U.real</span>
            <span class="c1"># # print(f&quot;max eigen value = {eig.max():.4e}, min eigen value = {eig.min():.4e}&quot;)</span>
            <span class="c1"># # eig = np.clip(eig, a_min=0., a_max=None)</span>
            <span class="c1"># # hess_np = U @ np.diag(eig) @ U.T</span>

            <span class="c1"># grad_np = self.particle_grad.numpy()[: self.n_particles].reshape(-1)</span>
            <span class="c1"># p_np = np.linalg.lstsq(hess_np, grad_np, rcond=None)[0]</span>
            <span class="c1"># wp_slice(self.particle_p, 0, self.n_particles).assign(p_np.reshape(-1, 3))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_p</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>

            <span class="c1"># TODO: compute p_inf_norm on CUDA</span>
            <span class="n">p_inf_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_p</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">p_inf_norm</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">eps_d</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">time_step</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">newton_iter</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">newton_max_iters</span><span class="p">:</span>
                <span class="n">ipc_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Newton iteration did not converge after </span><span class="si">{</span><span class="n">newton_iter</span><span class="si">}</span><span class="s2"> iterations, &quot;</span>
                    <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;p_inf = </span><span class="si">{</span><span class="n">p_inf_norm</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">break</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ccd</span><span class="o">.</span><span class="n">compute_step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_p</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">use_graph</span><span class="p">:</span>
                <span class="n">wp</span><span class="o">.</span><span class="n">capture_launch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_search_graph</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_line_search</span><span class="p">()</span>

            <span class="c1"># Check line search success</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_scenes</span><span class="p">]</span>
                    <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_prev</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_scenes</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">ipc_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Line search failed, energy increased for scenes </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n_scenes</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">energy_prev</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n_scenes</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="n">ipc_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Newton iteration </span><span class="si">{</span><span class="n">newton_iter</span><span class="si">}</span><span class="s2"> finished, energy = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[:</span><span class="bp">self</span><span class="o">.</span><span class="n">n_scenes</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>

        <span class="n">wp</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span>
            <span class="n">kernel</span><span class="o">=</span><span class="n">apply_parent_affine_kernel</span><span class="p">,</span>
            <span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">,</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">[</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_q_rest</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">block_indices</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">affine_block_ids</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_affine</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">wp</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span>
            <span class="n">kernel</span><span class="o">=</span><span class="n">compute_velocity_kernel</span><span class="p">,</span>
            <span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">,</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q_prev_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">time_step</span><span class="p">],</span>
            <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_qd</span><span class="p">],</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Clear DBC (if the user does not set them again, the particles will be free)</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_dbc_tag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">)</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">step_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">time_step</span>

    <span class="k">def</span> <span class="nf">register_fem_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">:</span> <span class="n">IPCFEMComponent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        component</span>
<span class="sd">        particle</span>
<span class="sd">        surface (particle, edge, triangle)</span>
<span class="sd">        block (general, tet)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">component</span>
        <span class="k">assert</span> <span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1">######## Component Data ########</span>

        <span class="n">cid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_components</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_components</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_components</span>
        <span class="n">c</span><span class="o">.</span><span class="n">id_in_system</span> <span class="o">=</span> <span class="n">cid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">component_friction</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">cid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">friction</span><span class="p">))</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">component_removed</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">cid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1">######## Scene Data ########</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">scene</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenes</span><span class="p">:</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_scenes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_scenes</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_scenes</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_scenes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scenes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">scene</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_planes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">scene</span><span class="p">)</span>

        <span class="c1">######## Particle Data ########</span>

        <span class="n">pl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span>  <span class="c1"># Particle Left (begin) id</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="n">pl</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span><span class="o">.</span><span class="n">n_vertices</span>  <span class="c1"># Particle Right (end) id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span> <span class="o">=</span> <span class="n">pr</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_particles</span>

        <span class="n">particle_q_slice</span> <span class="o">=</span> <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">array_slice</span> <span class="o">=</span> <span class="n">particle_q_slice</span>
        <span class="n">c</span><span class="o">.</span><span class="n">particle_begin_index</span> <span class="o">=</span> <span class="n">pl</span>
        <span class="n">c</span><span class="o">.</span><span class="n">particle_end_index</span> <span class="o">=</span> <span class="n">pr</span>
        <span class="n">c</span><span class="o">.</span><span class="n">cuda_pointer</span> <span class="o">=</span> <span class="n">particle_q_slice</span><span class="o">.</span><span class="n">ptr</span>
        <span class="n">c</span><span class="o">.</span><span class="n">cuda_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">cuda_stream</span>
        <span class="n">c</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">type_size_in_bytes</span><span class="p">(</span><span class="n">particle_q_slice</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">particle_q_slice</span><span class="o">.</span><span class="n">size</span>

        <span class="n">pose</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">get_pose</span><span class="p">()</span>
        <span class="n">transformation_matrix</span> <span class="o">=</span> <span class="n">pose</span><span class="o">.</span><span class="n">to_transformation_matrix</span><span class="p">()</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span><span class="o">.</span><span class="n">vertices</span> <span class="o">@</span> <span class="n">transformation_matrix</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="o">+</span> <span class="n">transformation_matrix</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_qd</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">init_velocity</span><span class="p">,</span> <span class="p">(</span><span class="n">pr</span> <span class="o">-</span> <span class="n">pl</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q_rest</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_mass</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">vertex_mass</span><span class="p">)</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_mask</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">pr</span> <span class="o">-</span> <span class="n">pl</span><span class="p">))</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_affine</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">AFFINE_NONE</span><span class="p">,</span> <span class="n">pr</span> <span class="o">-</span> <span class="n">pl</span><span class="p">))</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_component</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">pr</span> <span class="o">-</span> <span class="n">pl</span><span class="p">))</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_scene</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">pr</span> <span class="o">-</span> <span class="n">pl</span><span class="p">))</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_dbc_tag</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pr</span> <span class="o">-</span> <span class="n">pl</span><span class="p">))</span>

        <span class="c1">######## Surface Data ########</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span><span class="o">.</span><span class="n">n_surface_vertices</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">wp_slice</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">surface_particles</span><span class="p">[</span><span class="n">sid</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span><span class="o">.</span><span class="n">n_surface_vertices</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span><span class="o">.</span><span class="n">surface_vertices</span> <span class="o">+</span> <span class="n">pl</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">+=</span> <span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span><span class="o">.</span><span class="n">n_surface_vertices</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
                <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_surface_primitives_per_scene</span>
            <span class="p">)</span>
            <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">sid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span><span class="o">.</span><span class="n">n_surface_edges</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">wp_slice</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">surface_edges</span><span class="p">[</span><span class="n">sid</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges_list</span><span class="p">[</span><span class="n">sid</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span><span class="o">.</span><span class="n">n_surface_edges</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span><span class="o">.</span><span class="n">surface_edges</span> <span class="o">+</span> <span class="n">pl</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">+=</span> <span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span><span class="o">.</span><span class="n">n_surface_edges</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
                <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_surface_primitives_per_scene</span>
            <span class="p">)</span>
            <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">sid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges_list</span><span class="p">[</span><span class="n">sid</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span><span class="o">.</span><span class="n">n_surface_triangles</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">wp_slice</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">surface_triangles</span><span class="p">[</span><span class="n">sid</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span><span class="o">.</span><span class="n">n_surface_triangles</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span><span class="o">.</span><span class="n">surface_triangles</span> <span class="o">+</span> <span class="n">pl</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">+=</span> <span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span><span class="o">.</span><span class="n">n_surface_triangles</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
                <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_surface_primitives_per_scene</span>
            <span class="p">)</span>
            <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">sid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1">######## Block Data ########</span>

        <span class="n">bl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_static_blocks</span>  <span class="c1"># block left (begin) id</span>
        <span class="n">br</span> <span class="o">=</span> <span class="n">bl</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span><span class="o">.</span><span class="n">n_tets</span>  <span class="c1"># block right (end) id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_static_blocks</span> <span class="o">=</span> <span class="n">br</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_static_blocks</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_blocks</span>

        <span class="n">c</span><span class="o">.</span><span class="n">block_begin_index</span> <span class="o">=</span> <span class="n">bl</span>
        <span class="n">c</span><span class="o">.</span><span class="n">block_end_index</span> <span class="o">=</span> <span class="n">br</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span><span class="o">.</span><span class="n">n_tets</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_indices</span><span class="p">,</span> <span class="n">bl</span><span class="p">,</span> <span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span><span class="o">.</span><span class="n">tets</span> <span class="o">+</span> <span class="n">pl</span><span class="p">)</span>
            <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_status</span><span class="p">,</span> <span class="n">bl</span><span class="p">,</span> <span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">br</span> <span class="o">-</span> <span class="n">bl</span><span class="p">))</span>
            <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_type</span><span class="p">,</span> <span class="n">bl</span><span class="p">,</span> <span class="n">br</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">FEM_TET_BLOCK</span><span class="p">,</span> <span class="n">br</span> <span class="o">-</span> <span class="n">bl</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1">######## Block Data: FEM Tets ########</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span><span class="o">.</span><span class="n">n_tets</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">btl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_tets</span>  <span class="c1"># tet left (begin) id</span>
            <span class="n">btr</span> <span class="o">=</span> <span class="n">btl</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span><span class="o">.</span><span class="n">n_tets</span>  <span class="c1"># tet right (end) id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_tets</span> <span class="o">=</span> <span class="n">btr</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_tets</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_blocks</span>

            <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tet_block_ids</span><span class="p">,</span> <span class="n">btl</span><span class="p">,</span> <span class="n">btr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">bl</span><span class="p">,</span> <span class="n">br</span><span class="p">))</span>
            <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rest_volumes</span><span class="p">,</span> <span class="n">btl</span><span class="p">,</span> <span class="n">btr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">rest_volumes</span><span class="p">)</span>
            <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tet_inv_Dm</span><span class="p">,</span> <span class="n">btl</span><span class="p">,</span> <span class="n">btr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">inv_Dm</span><span class="p">)</span>
            <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tet_materials</span><span class="p">,</span> <span class="n">btl</span><span class="p">,</span> <span class="n">btr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">k_mu</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">k_lambda</span><span class="p">]),</span> <span class="p">(</span><span class="n">btr</span> <span class="o">-</span> <span class="n">btl</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">unregister_fem_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">:</span> <span class="n">IPCFEMComponent</span><span class="p">):</span>
        <span class="n">cid</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">id_in_system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">component_removed</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">cid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">component</span><span class="o">.</span><span class="n">tet_mesh</span><span class="o">.</span><span class="n">n_tets</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bl</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">block_begin_index</span>
            <span class="n">br</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">block_end_index</span>
            <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_status</span><span class="p">,</span> <span class="n">bl</span><span class="p">,</span> <span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">br</span> <span class="o">-</span> <span class="n">bl</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_vertex_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">IPCFEMComponent</span><span class="p">,</span> <span class="n">IPCABDComponent</span><span class="p">]):</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">particle_begin_index</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">particle_end_index</span>

        <span class="n">torch_wait_wp_stream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wp</span><span class="o">.</span><span class="n">to_torch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">)[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_vertex_velocities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">IPCFEMComponent</span><span class="p">,</span> <span class="n">IPCABDComponent</span><span class="p">]):</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">particle_begin_index</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">particle_end_index</span>

        <span class="n">torch_wait_wp_stream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wp</span><span class="o">.</span><span class="n">to_torch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_qd</span><span class="p">)[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_vertex_collision_forces</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">IPCFEMComponent</span><span class="p">,</span> <span class="n">IPCABDComponent</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">particle_begin_index</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">particle_end_index</span>

        <span class="n">torch_wait_wp_stream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wp</span><span class="o">.</span><span class="n">to_torch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_collision_force</span><span class="p">)[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_vertex_friction_forces</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">IPCFEMComponent</span><span class="p">,</span> <span class="n">IPCABDComponent</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">particle_begin_index</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">particle_end_index</span>

        <span class="n">torch_wait_wp_stream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wp</span><span class="o">.</span><span class="n">to_torch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_friction_force</span><span class="p">)[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_fem_positions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">component</span><span class="p">:</span> <span class="n">IPCFEMComponent</span><span class="p">,</span>
        <span class="n">positions</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">particle_begin_index</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">particle_end_index</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="n">positions</span><span class="o">.</span><span class="n">is_cuda</span><span class="p">:</span>
            <span class="n">wp_wait_torch_stream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">,</span> <span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">convert_to_wp_array</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_fem_velocities</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">component</span><span class="p">:</span> <span class="n">IPCFEMComponent</span><span class="p">,</span>
        <span class="n">velocities</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">particle_begin_index</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">particle_end_index</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">velocities</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="n">velocities</span><span class="o">.</span><span class="n">is_cuda</span><span class="p">:</span>
            <span class="n">wp_wait_torch_stream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_qd</span><span class="p">,</span> <span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">convert_to_wp_array</span><span class="p">(</span><span class="n">velocities</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_fem_kinematic_target</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">component</span><span class="p">:</span> <span class="n">IPCFEMComponent</span><span class="p">,</span>
        <span class="n">indices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">],</span>
        <span class="n">positions</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="c1"># TODO: assert component is registered</span>

        <span class="n">begin</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">particle_begin_index</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">particle_end_index</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">begin</span> <span class="o">&lt;=</span> <span class="n">end</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="n">indices</span><span class="o">.</span><span class="n">is_cuda</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="n">positions</span><span class="o">.</span><span class="n">is_cuda</span>
        <span class="p">):</span>
            <span class="n">wp_wait_torch_stream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="n">convert_to_wp_array</span><span class="p">(</span>
            <span class="n">indices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span>
        <span class="p">)</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">convert_to_wp_array</span><span class="p">(</span>
            <span class="n">positions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span>
        <span class="p">)</span>

        <span class="n">wp</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span>
            <span class="n">set_to_ones_at_indices_int_kernel</span><span class="p">,</span>
            <span class="n">dim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">),</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">[</span>
                <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_dbc_tag</span><span class="p">,</span> <span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">),</span>
                <span class="n">indices</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span>
            <span class="n">set_values_at_indices_vec3_kernel</span><span class="p">,</span>
            <span class="n">dim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">),</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">[</span>
                <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_dbc_q</span><span class="p">,</span> <span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">),</span>
                <span class="n">indices</span><span class="p">,</span>
                <span class="n">positions</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_abd_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">:</span> <span class="n">IPCABDComponent</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">component</span>
        <span class="k">assert</span> <span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">tri_mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1">######## Component Data ########</span>

        <span class="n">cid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_components</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_components</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_components</span>
        <span class="n">c</span><span class="o">.</span><span class="n">id_in_system</span> <span class="o">=</span> <span class="n">cid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">component_friction</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">cid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">friction</span><span class="p">))</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">component_removed</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">cid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1">######## Scene Data ########</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">scene</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenes</span><span class="p">:</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_scenes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_scenes</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_scenes</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_scenes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scenes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">scene</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_planes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">scene</span><span class="p">)</span>

        <span class="c1">######## Block Data ########</span>

        <span class="n">bl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_static_blocks</span>  <span class="c1"># block left (begin) id</span>
        <span class="n">br</span> <span class="o">=</span> <span class="n">bl</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># block right (end) id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_static_blocks</span> <span class="o">=</span> <span class="n">br</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_static_blocks</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_blocks</span>

        <span class="n">c</span><span class="o">.</span><span class="n">block_begin_index</span> <span class="o">=</span> <span class="n">bl</span>
        <span class="n">c</span><span class="o">.</span><span class="n">block_end_index</span> <span class="o">=</span> <span class="n">br</span>

        <span class="n">pxl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span>
        <span class="n">pxr</span> <span class="o">=</span> <span class="n">pxl</span> <span class="o">+</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span> <span class="o">=</span> <span class="n">pxr</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_particles</span>

        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_indices</span><span class="p">,</span> <span class="n">bl</span><span class="p">,</span> <span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pxl</span><span class="p">,</span> <span class="n">pxr</span><span class="p">))</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_status</span><span class="p">,</span> <span class="n">bl</span><span class="p">,</span> <span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">br</span> <span class="o">-</span> <span class="n">bl</span><span class="p">))</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_type</span><span class="p">,</span> <span class="n">bl</span><span class="p">,</span> <span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">ABD_AFFINE_BLOCK</span><span class="p">,</span> <span class="n">br</span> <span class="o">-</span> <span class="n">bl</span><span class="p">))</span>

        <span class="c1">######## Affine Data ########</span>

        <span class="n">al</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_affines</span>
        <span class="n">ar</span> <span class="o">=</span> <span class="n">al</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_affines</span> <span class="o">=</span> <span class="n">ar</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_affines</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_blocks</span>

        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">affine_block_ids</span><span class="p">,</span> <span class="n">al</span><span class="p">,</span> <span class="n">ar</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bl</span><span class="p">))</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">affine_volumes</span><span class="p">,</span> <span class="n">al</span><span class="p">,</span> <span class="n">ar</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">volume</span><span class="p">))</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">affine_mass</span><span class="p">,</span> <span class="n">al</span><span class="p">,</span> <span class="n">ar</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">abd_mass</span><span class="p">)</span>

        <span class="c1">######## Affine Proxy Data ########</span>

        <span class="n">pose</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">get_pose</span><span class="p">()</span>
        <span class="n">transformation_matrix</span> <span class="o">=</span> <span class="n">pose</span><span class="o">.</span><span class="n">to_transformation_matrix</span><span class="p">()</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">,</span> <span class="n">pxl</span><span class="p">,</span> <span class="n">pxr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">transformation_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span>
                    <span class="n">transformation_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span>
                    <span class="n">transformation_matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span>
                    <span class="n">transformation_matrix</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_qd</span><span class="p">,</span> <span class="n">pxl</span><span class="p">,</span> <span class="n">pxr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">init_velocity</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q_rest</span><span class="p">,</span> <span class="n">pxl</span><span class="p">,</span> <span class="n">pxr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">,</span> <span class="n">pxl</span><span class="p">,</span> <span class="n">pxr</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_mass</span><span class="p">,</span> <span class="n">pxl</span><span class="p">,</span> <span class="n">pxr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">vertex_mass</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_mask</span><span class="p">,</span> <span class="n">pxl</span><span class="p">,</span> <span class="n">pxr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_affine</span><span class="p">,</span> <span class="n">pxl</span><span class="p">,</span> <span class="n">pxr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">AFFINE_PROXY</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_component</span><span class="p">,</span> <span class="n">pxl</span><span class="p">,</span> <span class="n">pxr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_scene</span><span class="p">,</span> <span class="n">pxl</span><span class="p">,</span> <span class="n">pxr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_dbc_tag</span><span class="p">,</span> <span class="n">pxl</span><span class="p">,</span> <span class="n">pxr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="c1">######## Particle Data ########</span>

        <span class="n">mesh</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">tet_mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">c</span><span class="o">.</span><span class="n">tri_mesh</span>

        <span class="n">pl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span>  <span class="c1"># Particle Left (begin) id</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="n">pl</span> <span class="o">+</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_vertices</span>  <span class="c1"># Particle Right (end) id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span> <span class="o">=</span> <span class="n">pr</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_particles</span>

        <span class="n">particle_q_slice</span> <span class="o">=</span> <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">array_slice</span> <span class="o">=</span> <span class="n">particle_q_slice</span>
        <span class="n">c</span><span class="o">.</span><span class="n">particle_begin_index</span> <span class="o">=</span> <span class="n">pl</span>
        <span class="n">c</span><span class="o">.</span><span class="n">particle_end_index</span> <span class="o">=</span> <span class="n">pr</span>
        <span class="n">c</span><span class="o">.</span><span class="n">cuda_pointer</span> <span class="o">=</span> <span class="n">particle_q_slice</span><span class="o">.</span><span class="n">ptr</span>
        <span class="n">c</span><span class="o">.</span><span class="n">cuda_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">cuda_stream</span>
        <span class="n">c</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">type_size_in_bytes</span><span class="p">(</span><span class="n">particle_q_slice</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">particle_q_slice</span><span class="o">.</span><span class="n">size</span>

        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span> <span class="o">@</span> <span class="n">transformation_matrix</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="o">+</span> <span class="n">transformation_matrix</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_qd</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">init_velocity</span><span class="p">,</span> <span class="p">(</span><span class="n">pr</span> <span class="o">-</span> <span class="n">pl</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q_rest</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_mass</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">vertex_mass</span><span class="p">)</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_mask</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">pr</span> <span class="o">-</span> <span class="n">pl</span><span class="p">))</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_affine</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">al</span><span class="p">,</span> <span class="n">pr</span> <span class="o">-</span> <span class="n">pl</span><span class="p">))</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_component</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">pr</span> <span class="o">-</span> <span class="n">pl</span><span class="p">))</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_scene</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">pr</span> <span class="o">-</span> <span class="n">pl</span><span class="p">))</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_dbc_tag</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pr</span> <span class="o">-</span> <span class="n">pl</span><span class="p">))</span>

        <span class="c1">######## Surface Data ########</span>

        <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_surface_vertices</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">wp_slice</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">surface_particles</span><span class="p">[</span><span class="n">sid</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">+</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_surface_vertices</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">surface_vertices</span> <span class="o">+</span> <span class="n">pl</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">+=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_surface_vertices</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
                <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_surface_primitives_per_scene</span>
            <span class="p">)</span>
            <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">sid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_surface_edges</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">wp_slice</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">surface_edges</span><span class="p">[</span><span class="n">sid</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges_list</span><span class="p">[</span><span class="n">sid</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">+</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_surface_edges</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">surface_edges</span> <span class="o">+</span> <span class="n">pl</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">+=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_surface_edges</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
                <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_surface_primitives_per_scene</span>
            <span class="p">)</span>
            <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">sid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges_list</span><span class="p">[</span><span class="n">sid</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_surface_triangles</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">wp_slice</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">surface_triangles</span><span class="p">[</span><span class="n">sid</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">+</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_surface_triangles</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">surface_triangles</span> <span class="o">+</span> <span class="n">pl</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">+=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">n_surface_triangles</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
                <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_surface_primitives_per_scene</span>
            <span class="p">)</span>
            <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">sid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles_list</span><span class="p">[</span><span class="n">sid</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">unregister_abd_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">:</span> <span class="n">IPCABDComponent</span><span class="p">):</span>
        <span class="n">cid</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">id_in_system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">component_removed</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">cid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">bl</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">block_begin_index</span>
        <span class="n">br</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">block_end_index</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_status</span><span class="p">,</span> <span class="n">bl</span><span class="p">,</span> <span class="n">br</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">br</span> <span class="o">-</span> <span class="n">bl</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_abd_proxy_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">:</span> <span class="n">IPCABDComponent</span><span class="p">):</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">particle_begin_index</span>
        <span class="k">assert</span> <span class="n">begin</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">begin</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span>

        <span class="n">torch_wait_wp_stream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wp</span><span class="o">.</span><span class="n">to_torch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">)[</span><span class="n">begin</span> <span class="o">-</span> <span class="mi">4</span> <span class="p">:</span> <span class="n">begin</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_abd_proxy_velocities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">:</span> <span class="n">IPCABDComponent</span><span class="p">):</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">particle_begin_index</span>
        <span class="k">assert</span> <span class="n">begin</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">begin</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span>

        <span class="n">torch_wait_wp_stream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wp</span><span class="o">.</span><span class="n">to_torch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_qd</span><span class="p">)[</span><span class="n">begin</span> <span class="o">-</span> <span class="mi">4</span> <span class="p">:</span> <span class="n">begin</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_abd_proxy_positions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">component</span><span class="p">:</span> <span class="n">IPCFEMComponent</span><span class="p">,</span>
        <span class="n">proxy_positions</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        mat: 4x3 matrix. [a1, a2, a3, p].</span>
<span class="sd">        Affine transformation is x -&gt; [a1.x, a2.x, a3.x] + p</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">particle_begin_index</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proxy_positions</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="n">proxy_positions</span><span class="o">.</span><span class="n">is_cuda</span><span class="p">:</span>
            <span class="n">wp_wait_torch_stream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="n">proxy_positions</span> <span class="o">=</span> <span class="n">convert_to_wp_array</span><span class="p">(</span>
            <span class="n">proxy_positions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span>
        <span class="p">)</span>

        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">,</span> <span class="n">begin</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="n">begin</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">proxy_positions</span><span class="p">)</span>

        <span class="n">wp</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span>
            <span class="n">kernel</span><span class="o">=</span><span class="n">apply_parent_affine_kernel</span><span class="p">,</span>
            <span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">,</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">[</span>
                <span class="n">begin</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_q_rest</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">block_indices</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">affine_block_ids</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_affine</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_abd_proxy_velocities</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">component</span><span class="p">:</span> <span class="n">IPCFEMComponent</span><span class="p">,</span>
        <span class="n">proxy_velocities</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        v_mat: 4x3 matrix. [v_a1, v_a2, v_a3, v_p] = d/dt [a1, a2, a3, p].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">particle_begin_index</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proxy_velocities</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="n">proxy_velocities</span><span class="o">.</span><span class="n">is_cuda</span><span class="p">:</span>
            <span class="n">wp_wait_torch_stream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="n">proxy_velocities</span> <span class="o">=</span> <span class="n">convert_to_wp_array</span><span class="p">(</span>
            <span class="n">proxy_velocities</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span>
        <span class="p">)</span>

        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_qd</span><span class="p">,</span> <span class="n">begin</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="n">begin</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">proxy_velocities</span><span class="p">)</span>

        <span class="n">wp</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span>
            <span class="n">kernel</span><span class="o">=</span><span class="n">apply_parent_affine_kernel</span><span class="p">,</span>
            <span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">,</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">[</span>
                <span class="n">begin</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_qd</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_q_rest</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">block_indices</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">affine_block_ids</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_affine</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_abd_kinematic_target</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">component</span><span class="p">:</span> <span class="n">IPCABDComponent</span><span class="p">,</span>
        <span class="n">proxy_positions</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">particle_begin_index</span>
        <span class="k">assert</span> <span class="n">begin</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">begin</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proxy_positions</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="n">proxy_positions</span><span class="o">.</span><span class="n">is_cuda</span><span class="p">:</span>
            <span class="n">wp_wait_torch_stream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="n">proxy_positions</span> <span class="o">=</span> <span class="n">convert_to_wp_array</span><span class="p">(</span>
            <span class="n">proxy_positions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span>
        <span class="p">)</span>

        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_dbc_tag</span><span class="p">,</span> <span class="n">begin</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="n">begin</span><span class="p">)</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_dbc_q</span><span class="p">,</span> <span class="n">begin</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="n">begin</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">proxy_positions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_plane_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">:</span> <span class="n">IPCPlaneComponent</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">component</span>

        <span class="c1">######## Component Data ########</span>

        <span class="n">cid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_components</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_components</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_components</span>
        <span class="n">c</span><span class="o">.</span><span class="n">id_in_system</span> <span class="o">=</span> <span class="n">cid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">component_friction</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">cid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">friction</span><span class="p">))</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">component_removed</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">cid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1">######## Scene Data ########</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">scene</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenes</span><span class="p">:</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_scenes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_scenes</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_scenes</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_scenes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scenes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">scene</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_planes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">scene</span><span class="p">)</span>

        <span class="c1">######## Plane Data ########</span>

        <span class="n">gid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_planes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_planes</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_planes</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_planes</span>

        <span class="n">pose</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">get_pose</span><span class="p">()</span>
        <span class="n">transformation_matrix</span> <span class="o">=</span> <span class="n">pose</span><span class="o">.</span><span class="n">to_transformation_matrix</span><span class="p">()</span>
        <span class="n">new_normal</span> <span class="o">=</span> <span class="n">transformation_matrix</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">@</span> <span class="n">c</span><span class="o">.</span><span class="n">normal</span>
        <span class="n">new_offset</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">new_normal</span><span class="p">,</span> <span class="n">transformation_matrix</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plane_normals</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">new_normal</span><span class="p">)</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plane_offsets</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_offset</span><span class="p">))</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plane_component</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cid</span><span class="p">))</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plane_scene</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sid</span><span class="p">))</span>

        <span class="c1">######## Surface Data ########</span>

        <span class="n">wp_slice</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">surface_planes</span><span class="p">[</span><span class="n">sid</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_planes_list</span><span class="p">[</span><span class="n">sid</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_planes_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gid</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_planes_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_planes_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_planes_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_planes_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_planes_list</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
            <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_surface_primitives_per_scene</span>
        <span class="p">)</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_surface_planes</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">sid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_surface_planes_list</span><span class="p">[</span><span class="n">sid</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">unregister_plane_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">:</span> <span class="n">IPCPlaneComponent</span><span class="p">):</span>
        <span class="n">cid</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">id_in_system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">component_removed</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">cid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">rebuild</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rebuild the system with the current components, ignoring all unregistered (removed) components. This makes the memory contigous again, and improves performance.&quot;&quot;&quot;</span>
        <span class="n">components_to_register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">q_mem</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">qd_mem</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">components_to_register</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">IPCFEMComponent</span><span class="p">):</span>
                <span class="n">q_mem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">get_positions</span><span class="p">())</span>
                <span class="n">qd_mem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">get_velocities</span><span class="p">())</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">IPCABDComponent</span><span class="p">):</span>
                <span class="n">q_mem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">get_proxy_positions</span><span class="p">())</span>
                <span class="n">qd_mem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">get_proxy_velocities</span><span class="p">())</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">IPCPlaneComponent</span><span class="p">):</span>
                <span class="n">q_mem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">qd_mem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scenes</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># For now, just clear all counts and re-register all components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_components</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_scenes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_planes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># FEM vertices + ABD affine proxies + ABD vertices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_tets</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># FEM tets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_affines</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># ABD affine bodies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_static_blocks</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># FEM tets + ABD affine bodies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_blocks_this_step</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># static blocks + contact blocks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_triangles_list</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># surface triangles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_edges_list</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># surface edges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_particles_list</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># surface vertices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_surface_planes_list</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># surface planes</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">step_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># increment by config.time_step every step</span>

        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">qd</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">components_to_register</span><span class="p">,</span> <span class="n">q_mem</span><span class="p">,</span> <span class="n">qd_mem</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">IPCFEMComponent</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">register_fem_component</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">set_velocities</span><span class="p">(</span><span class="n">qd</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">IPCABDComponent</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">register_abd_component</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">set_proxy_positions</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">set_proxy_velocities</span><span class="p">(</span><span class="n">qd</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">IPCPlaneComponent</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">register_plane_component</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_zero_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_scenes</span><span class="p">)</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_zero_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_grad</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">)</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_blocks_this_step</span><span class="p">)</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_collision_force</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">)</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
        <span class="n">wp_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_friction_force</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">)</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_process_dbc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wp</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span>
            <span class="n">kernel</span><span class="o">=</span><span class="n">masked_diff_kernel</span><span class="p">,</span>
            <span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">,</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_dbc_q</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_dbc_tag</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_dbc_delta_q</span><span class="p">],</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># ipc_logger.debug(f&quot;system.particle_dbc_mask: {self.particle_dbc_mask.numpy()[:self.n_particles]}&quot;)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccd</span><span class="o">.</span><span class="n">compute_step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_dbc_delta_q</span><span class="p">)</span>

        <span class="n">wp</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span>
            <span class="n">kernel</span><span class="o">=</span><span class="n">process_dbc_kernel</span><span class="p">,</span>
            <span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">,</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ccd_step</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_scene</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">block_indices</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">affine_block_ids</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_affine</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_dbc_delta_q</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_dbc_tag</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_dbc_mask</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_mask</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># ipc_logger.debug(f&quot;system.ccd_step: {self.ccd_step.numpy()[0]}&quot;)</span>
        <span class="c1"># ipc_logger.debug(f&quot;system.particle_mask: {self.particle_mask.numpy()[:self.n_particles]}&quot;)</span>
        <span class="c1"># ipc_logger.debug(f&quot;system.particle_dbc_mask: {self.particle_dbc_mask.numpy()[:self.n_particles]}&quot;)</span>

    <span class="k">def</span> <span class="nf">_preprocess_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_prev</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">x_prev</span><span class="p">)</span>
        <span class="c1"># Generate contact_type, contact_d, contact_c, contact_eps_cross, block_status...</span>
        <span class="c1"># ... for friction_preprocess_kernel to use</span>
        <span class="k">if</span> <span class="s2">&quot;friction&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_calcs</span><span class="p">:</span>
            <span class="k">assert</span> <span class="s2">&quot;collision&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_calcs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">energy_calcs</span><span class="p">[</span><span class="s2">&quot;collision&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">compute_energy</span><span class="p">(</span><span class="n">x_prev</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">energy_calcs</span><span class="p">[</span><span class="s2">&quot;friction&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">x_prev</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">output_debug_info</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zero_energy</span><span class="p">()</span>
        <span class="n">last_energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_scenes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">debug_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">energy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_calcs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">energy</span><span class="o">.</span><span class="n">compute_energy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">output_debug_info</span><span class="p">:</span>
                <span class="n">new_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_scenes</span><span class="p">]</span>
                <span class="n">delta_energy</span> <span class="o">=</span> <span class="n">new_energy</span> <span class="o">-</span> <span class="n">last_energy</span>
                <span class="n">last_energy</span> <span class="o">=</span> <span class="n">new_energy</span>
                <span class="n">debug_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">delta_energy</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="k">if</span> <span class="n">output_debug_info</span><span class="p">:</span>
            <span class="n">ipc_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;energy=</span><span class="si">{</span><span class="n">last_energy</span><span class="si">}</span><span class="s2"> ( </span><span class="si">{</span><span class="n">debug_str</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">grad_coeff</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_blocks_this_step</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_static_blocks</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;n_blocks_this_step &lt; n_static_blocks. Did you forget to call system.filter.filter()?&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zero_diff</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">energy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_calcs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">energy</span><span class="o">.</span><span class="n">compute_diff</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">grad_coeff</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">spd_project_max</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span>
                <span class="n">kernel</span><span class="o">=</span><span class="n">block_spd_project_kernel</span><span class="p">,</span>
                <span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_blocks_this_step</span><span class="p">,</span>
                <span class="n">inputs</span><span class="o">=</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">block_type</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">block_status</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">spd_project_max</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_line_search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Line search: find E(self.particle_q_prev_it + alpha * self.particle_p)</span>
<span class="sd">        &lt; E(self.particle_q_prev_it).</span>
<span class="sd">        Starting from self.ccd_step, halve alpha until the energy decreases.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">wp</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_prev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_scenes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n_halves</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">line_search_max_iters</span><span class="p">):</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span>
                <span class="n">kernel</span><span class="o">=</span><span class="n">line_search_iteration_kernel</span><span class="p">,</span>
                <span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">,</span>
                <span class="n">inputs</span><span class="o">=</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">particle_q_prev_it</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">particle_p</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ccd_step</span><span class="p">,</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">n_halves</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">particle_scene</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">energy_prev</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">],</span>
                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_energy</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_q</span><span class="p">,</span>
                <span class="n">output_debug_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">use_graph</span>
                <span class="ow">and</span> <span class="n">n_halves</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">line_search_max_iters</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_dense_matrix_brute_force</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dense_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">):</span>
            <span class="n">one_hot_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">)</span>
            <span class="n">one_hot_np</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">one_hot_wp</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">one_hot_np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">wp</span><span class="o">.</span><span class="n">vec3</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span>
            <span class="p">)</span>
            <span class="n">prod</span> <span class="o">=</span> <span class="n">wp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">one_hot_wp</span><span class="p">)</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span>
                <span class="n">kernel</span><span class="o">=</span><span class="n">hess_block_mul_dx_kernel</span><span class="p">,</span>
                <span class="n">dim</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_blocks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">),</span>
                <span class="n">inputs</span><span class="o">=</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_static_blocks</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">contact_counter</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">particle_mass</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">particle_mask</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">particle_dbc_mask</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">kappa_con</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">block_indices</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">affine_block_ids</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">particle_affine</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">block_status</span><span class="p">,</span>
                    <span class="n">one_hot_wp</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">particle_q_rest</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">prod</span><span class="p">],</span>
                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">prod_np</span> <span class="o">=</span> <span class="n">prod</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dense_matrix</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">prod_np</span>
        <span class="k">return</span> <span class="n">dense_matrix</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Rabbit-Hu.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>